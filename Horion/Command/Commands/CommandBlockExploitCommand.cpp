#include "CommandBlockExploitCommand.h"

#include "../../../SDK/Mojangson.h"
#include "../../Module/ModuleManager.h"

CommandBlockExploitCommand::CommandBlockExploitCommand() : IMCCommand("commandblockexploit", "Workaround for executing commands without op", "<beehive/movingblock/bucket> <minecart/npc> <command>") {
	registerAlias("cbe");
}

CommandBlockExploitCommand::~CommandBlockExploitCommand() {
}

bool CommandBlockExploitCommand::execute(std::vector<std::string>* args) {
	assertTrue(args->size() > 3);

	std::ostringstream os;
	for (int i = 3; i < args->size(); i++) {
		if (i > 3)
			os << " ";
		os << args->at(i);
	}
	std::string cmd = os.str();

	std::string type = args->at(1);
	std::transform(type.begin(), type.end(), type.begin(), tolower);

	std::string mode = args->at(2);
	std::transform(mode.begin(), mode.end(), mode.begin(), tolower);

	ItemStack item;
	std::string tag;
	try {
		if (type == "beehive" || type == "bh") {
			auto regItem = Game.getItemRegistry()->lookUpByName("beehive");
			item = ItemStack(*regItem, 1, 0);
			if (mode == "minecart") {
				tag = R"({Block:{name:"minecraft:beehive",version:17959425},Count:1b,Damage:0s,Name:"minecraft:beehive",WasPickedUp:0b,tag:{Occupants:[{ActorIdentifier:"minecraft:command_block_minecart<>",SaveData:{Command:")" + cmd + R"(",Persistent:1b,Pos:[],Ticking:1b,identifier:"minecraft:command_block_minecart"},TicksLeftToStay:0}],display:{Lore:[")" + cmd + R"("],Name:"§g§lBeehive Minecart Command"},ench:[{id:28s,lvl:1s}]}})";
			} else if (mode == "npc") {
				tag = R"({Block:{name:"minecraft:beehive",version:17959425},Count:1b,Damage:0s,Name:"minecraft:beehive",WasPickedUp:0b,tag:{Occupants:[{ActorIdentifier:"minecraft:npc<>",SaveData:{Actions:"[{"button_name":"Execute Command","data":[{"cmd_line":")" + cmd + R"(","cmd_ver":12}],"mode":0,"text":")" + cmd + R"(","type":1},{"button_name":"KillButton","data":[{"cmd_line":"kill@e[type=npc,r=1]","cmd_ver":12}],"mode":0,"text":"kill@e[type=npc,r=1]","type":1}]",Persistent:1b,Pos:[],Variant:19,identifier:"minecraft:npc"},TicksLeftToStay:0}],display:{Lore:[")" + cmd + R"("],Name:"§g§lBeehive NPC Command"},ench:[{id:28s,lvl:1s}]}})";
			} else
				return false;
		} else if (type == "movingblock" || type == "mb") {
			auto regItem = Game.getItemRegistry()->lookUpByName("movingblock");
			item = ItemStack(*regItem, 1, 0);
			if (mode == "minecart") {
				tag = R"({Block:{name:"minecraft:moving_block",states:{},version:17959425},Count:1b,Damage:0s,Name:"minecraft:moving_block",WasPickedUp:0b,tag:{display:{Lore:[")" + cmd + R"("],Name:"§g§lMovingBlock Minecart Command"},ench:[{id:28s,lvl:1s}],movingBlock:{name:"minecraft:air"},movingEntity:{Occupants:[{ActorIdentifier:"minecraft:command_block_minecart<>",SaveData:{Command:")" + cmd + R"(",Persistent:1b,Pos:[],Ticking:1b,identifier:"minecraft:command_block_minecart"},TicksLeftToStay:0}],id:"Beehive"},pistonPosX:0,pistonPosY:0,pistonPosZ:0}})";
			} else if (mode == "npc") {
				tag = R"({Block:{name:"minecraft:moving_block",states:{},version:17959425},Count:1b,Damage:0s,Name:"minecraft:moving_block",WasPickedUp:0b,tag:{display:{Lore:[")" + cmd + R"("],Name:"§g§lMovingBlock NPC Command"},ench:[{id:28s,lvl:1s}],movingBlock:{name:"minecraft:air"},movingEntity:{Occupants:[{ActorIdentifier:"minecraft:npc<>",SaveData:{Actions:"[{"button_name":"Execute Command","data":[{"cmd_line":")" + cmd + R"(","cmd_ver":12}],"mode":0,"text":")" + cmd + R"(","type":1},{"button_name":"KillButton","data":[{"cmd_line":"kill@e[type=npc,r=1]","cmd_ver":12}],"mode":0,"text":"kill@e[type=npc,r=1]","type":1}]",Persistent:1b,Pos:[],Variant:19,identifier:"minecraft:npc"},TicksLeftToStay:0}],id:"Beehive"},pistonPosX:0,pistonPosY:0,pistonPosZ:0}})";
			} else
				return false;
		} else if (type == "bucket" || type == "bkt") {
			auto regItem = Game.getItemRegistry()->lookUpByName("axolotl_bucket");
			item = ItemStack(*regItem, 1, 0);	
			if (mode == "minecart") {
				tag = R"({Count:1b,Damage:0s,Name:"minecraft:axolotl_bucket",tag:{Pos:[0f,0f,0f],Persistent:1b,Ticking:1b,Command:")" + cmd + R"(",definitions:["+minecraft:command_block_minecart"],display:{Name:"§g§lBucket Minecart Command",Lore:[")" + cmd + R"("]},ench:[{id:28s,lvl:1s}]}})";
			} else if (mode == "npc") {
				tag = R"({Count:1b,Damage:0s,Name:"minecraft:axolotl_bucket",tag:{Pos:[0f,0f,0f],Persistent:1b,Variant:19,CustomName:"NPC",Actions:"[{"button_name":"Execute Command","data":[{"cmd_line":")" + cmd + R"(","cmd_ver":12}],"mode":0,"text":")" + cmd + R"(","type":1},{"button_name":"KillButton","data":[{"cmd_line":"kill@e[type=npc,r=1]","cmd_ver":12}],"mode":0,"text":"kill@e[type=npc,r=1]","type":1}]",definitions:["+minecraft:npc"],display:{Name:"§g§lBucket NPC Command",Lore:[")" + cmd + R"("]},ench:[{id:28s,lvl:1s}]}})";
			} else
				return false;
		}
		else
			return false;

		item.fromTag(*Mojangson::Parse(tag));
		Game.getTransactionManager()->addAction(InventoryAction(Game.getInventory()->getFirstEmptySlot(), nullptr, &item));
		Game.getTransactionManager()->addAction(InventoryAction(0, &item, nullptr, ContainerID::Inventory, InventorySource::Type::NotImplemented));
		Game.getInventory()->addItemToFirstEmptySlot(&item);

	} catch (Mojangson::Exception& e) {
		clientMessageF("%sError creating the item: %s", RED, e.what());
		return true;
	}

	clientMessageF("%sPlace the item down to execute the command!", GREEN);
	return true;
}